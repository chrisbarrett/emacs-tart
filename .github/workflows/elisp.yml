name: Emacs Lisp

on:
  push:
    branches: [main]
    paths:
      - 'lisp/**'
      - 'lib/**'
      - 'bin/**'
      - 'dune-project'
      - 'tart.opam'
  pull_request:
    branches: [main]
    paths:
      - 'lisp/**'
      - 'lib/**'
      - 'bin/**'
      - 'dune-project'
      - 'tart.opam'

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - emacs: emacsGit
            advisory: false
          - emacs: emacs30
            advisory: true

    name: test (${{ matrix.emacs }})
    continue-on-error: ${{ matrix.advisory }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Byte compile
        run: |
          nix develop .#${{ matrix.emacs }} --command emacs -Q --batch \
            -L lisp/ \
            --eval "(setq byte-compile-error-on-warn t)" \
            -f batch-byte-compile lisp/tart.el lisp/tart-mode.el

      - name: Run tests
        run: |
          nix develop .#${{ matrix.emacs }} --command emacs -Q --batch \
            -L lisp/ \
            -l ert \
            -l lisp/tart-test-helpers.el \
            -l lisp/tart-tests.el \
            -l lisp/tart-mode-tests.el \
            -f ert-run-tests-batch-and-exit

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Checkdoc
        run: |
          nix develop .#emacs30 --command emacs -Q --batch \
            -L lisp/ \
            --eval "(require 'checkdoc)" \
            --eval "(setq checkdoc-force-docstrings-flag nil)" \
            --eval "(checkdoc-file \"lisp/tart.el\")" \
            --eval "(checkdoc-file \"lisp/tart-mode.el\")"

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Cache opam
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.opam
            _opam
          key: opam-${{ runner.os }}-${{ hashFiles('tart.opam') }}
          restore-keys: opam-${{ runner.os }}-

      - name: Build tart binary
        run: nix develop --command dune build

      - name: Upload binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: tart-binary
          path: _build/default/bin/main.exe

  e2e:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - emacs: emacsGit
            advisory: false
          - emacs: emacs30
            advisory: true

    name: e2e (${{ matrix.emacs }})
    continue-on-error: ${{ matrix.advisory }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Download binary
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: tart-binary
          path: bin

      - name: Run E2E tests
        run: |
          chmod +x bin/main.exe
          nix develop .#${{ matrix.emacs }} --command emacs -Q --batch \
            -L lisp/ \
            --eval "(setq tart-executable \"$PWD/bin/main.exe\")" \
            -l ert \
            -l lisp/tart-test-helpers.el \
            -l lisp/tart-e2e-tests.el \
            -f ert-run-tests-batch-and-exit
